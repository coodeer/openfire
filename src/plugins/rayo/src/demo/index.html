<html>
  <head>
	<link rel="stylesheet" href="bootstrap.min.css">
	<link rel="stylesheet" href="dialpad.css">
	<link rel="stylesheet" href="candybar.css">

    <script src="jquery_1_4_2.js"></script>
	<script src="md5.js"></script>
	<script src="base64.js"></script>
	<script src="strophe.js"></script>
    <script src="strophe-openfire.js"></script>
    <script src="rayo-plugin.js"></script>

	<script src="candybar.js"></script>
	<script src="att.phonenumber.js"></script>
	<script src="dialpad.js"></script>
    <script>

	var avatar = 'unknown.jpg';
	var domain = "81.201.82.25";
	var prefix = "sip:";
	var ringtone;

	window.dialer = new Dialpad({
		onPress: function (key) {
			console.log('a key was pressed', key);

			if (window.candybar.call) window.candybar.call.digit(key);
		},
		onCallableNumber: function (number) {
			console.log('we have a number that seems callable', number);
			//makeCall(number);
		},
		onHide: function () {
			console.log('removed it');
		},
		onCall: function (number) {

			if (window.dialer.getCallLabel() == "Call") {
				console.log('The call button was pressed', number);
				makeCall(number);

			} else if (window.dialer.getCallLabel() == "Hangup") {
				window.candybar.call.hangup();

			} else {
				window.candybar.call.answer();
			}
		}
	});

	window.candybar = new CandyBar();

    $(document).ready(function()
    {
		document.getElementById("dialpadDiv").insertBefore(window.dialer.render());

		window.candybar.render();
		window.candybar.call = null;

		if (urlParam("prefix")) prefix = urlParam("prefix");
		if (urlParam("domain")) domain = urlParam("domain");

		if (domain == "81.201.82.25" && prefix == "sip:") prefix = "sip:883510";
		if (prefix == "tel:") domain = "";
		if (prefix == "xmpp:") domain = window.location.hostname;

		var iNum = urlParam("inum");

		if (!iNum)
		{
			iNum = Math.random().toString(36).substr(2,9);
		}
		window.connection = new Openfire.Connection(window.location.protocol + '//' + window.location.host + '/http-bind/');
		window.connection.resource = iNum;

		window.connection.connect(window.location.hostname, null, function (status)
		{
			//console.log("XMPPConnection.connect");
			//console.log(status);

			if (status === Strophe.Status.CONNECTED)
			{
				$("#status").html("Ready");
				window.connection.send($pres());

				$(window).unload( function() {
					window.connection.disconnect();
				});

				setPhone();
			}
		});

		var destination = urlParam("destination");

		if (destination)
		{
			makeCall(destination);
		}
    })


   function setPhone()
   {
		console.log("setPhone()");

		if (window.connection)
		{
			window.connection.rayo.phone(
			{
				onReady: function() {
					console.log('Handset is off hook');
					$("#status").html("Off Hook");
				},

				onUnready: function() {
					console.log('Handset is on hook');
					$("#status").html("On Hook");
				},

				onOffer: function(call, headers) {
					console.log('onOffer ' + call.from);
					console.log(headers);

					if (window.candybar.call == null)	// ignore when user has active call
					{
						window.candybar.setUser({
							name: call.from,
							number: call.to,
							picUrl: 'unknown.jpg'
						});

						window.candybar.call = call;
						window.candybar.setState('incoming');
						window.dialer.setCallLabel('Answer');
					}
				},

				onEnd: function(callId, headers) {
					console.log('onEnd ' + callId);
					console.log(headers);

					window.candybar.endGently();
					window.candybar.call = null;

					window.dialer.setCallLabel('Call');
				},

				onAnswer: function(callId, headers) {
					console.log('onAnswer ' + callId);
					console.log(headers);

					window.candybar.setState('active');
					window.dialer.setCallLabel('Hangup');
					stopTone();
				},

				onRing: function(callId, headers) {
					console.log('onRing ' + callId);
					console.log(headers);

					window.candybar.setState('calling');
					startTone("ringback-uk");
				},

				onError: function(e) {
					console.error(e);
				}
			});
		}
   }

   function makeCall(destination)
   {
		console.log("makeCall " + destination);

		var sipUri = prefix + destination + "@" + domain

		if (prefix == "tel:") sipUri = prefix + destination

		window.candybar.call = window.connection.rayo.dial("xmpp:" + window.connection.jid, sipUri);

		window.candybar.setUser({
			name: sipUri,
			number: destination,
			picUrl: 'unknown.jpg'
		});
    }

	function onIncomingCall(call)
	{
		console.log(' call from ' + call.from);

		if (window.candybar.call == null)	// ignore when user has active call
		{
			window.candybar.setUser({
				name: call.from,
				number: call.to,
				picUrl: 'unknown.jpg'
			});

			window.candybar.call = call;
			window.candybar.setState('incoming');
			window.dialer.setCallLabel('Answer');
		}
	}


    function urlParam(name)
    {
		var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
		if (!results) { return undefined; }
		return decodeURIComponent(results[1]) || undefined;
    }

    function startTone(name)
    {
		ringtone = new Audio();
		ringtone.loop = true;
		ringtone.src = "ringtones/" + name + ".mp3";
		ringtone.play();
    }

    function stopTone()
    {
    	if (ringtone)
    	{
			ringtone.pause();
			ringtone = null;
		}
    }

    </script>
  </head>
  <body>
	<div id="dialpadDiv" style="position: absolute; width: 500px: height: 300px;"/>
    <span id="status">Loading...</span>
  </body>
</html>